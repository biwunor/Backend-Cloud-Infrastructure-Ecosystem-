# AWS RDS PostgreSQL Implementation Guide

**Version:** 1.0.0  
**Last Updated:** April 16, 2025  
**Author:** Bonaventure  
**Project:** UW Help App - Waste Management Platform

## Overview

This document provides detailed information about the PostgreSQL RDS implementation for the UW Help App. It covers the database architecture, configuration, security measures, backup strategies, and maintenance procedures.

## Database Architecture

### Instance Configuration

| Environment | Instance Type | vCPU | Memory | Storage Type | Initial Storage | Max Storage |
|-------------|--------------|------|--------|--------------|-----------------|-------------|
| Development | db.t4g.small | 2    | 2 GB   | gp3          | 20 GB           | 100 GB      |
| Staging     | db.t4g.medium| 2    | 4 GB   | gp3          | 50 GB           | 200 GB      |
| Production  | db.m6g.large | 2    | 8 GB   | gp3          | 100 GB          | 500 GB      |

### High Availability Configuration

- **Multi-AZ Deployment**: Enabled for staging and production environments
- **Availability Zones**: Deployed across three availability zones
- **Failover Priority**: Determined automatically based on the health of replica instances
- **Failover Time**: Typically 60-120 seconds, with DNS propagation time

### Scalability Options

- **Storage Auto Scaling**: Enabled with defined maximum limits
- **Read Replicas**: Configurable for production (not enabled by default)
- **Instance Scaling**: Manual vertical scaling through Terraform configuration

## Security Measures

### Network Security

- **VPC Placement**: Deployed in private subnets with no public accessibility
- **Security Groups**: Access restricted to application servers only
- **Port**: Standard PostgreSQL port (5432)
- **Network ACLs**: Additional layer of network traffic control

### Data Protection

- **Encryption at Rest**: Enabled using AWS KMS
- **Encryption in Transit**: TLS/SSL required for all connections
- **DB Parameter Group**: Custom parameter group with secure defaults
  - `rds.force_ssl = 1` (Forces SSL connections)
  - `log_connections = 1` (Logs all connection attempts)
  - `log_disconnections = 1` (Logs all disconnections)
  - `log_statement = 'ddl'` (Logs all DDL statements)

### Authentication and Access Control

- **Master User**: Generated by Terraform and stored in AWS Secrets Manager
- **IAM Authentication**: Optional enhanced security using IAM roles
- **Application Role**: Limited privileges following principle of least privilege
- **Connection Pooling**: Implemented at application level (not RDS Proxy)

## Backup and Recovery

### Automated Backups

- **Backup Window**: 02:00-04:00 UTC (configurable)
- **Backup Retention**: 1 day (development), 3 days (staging), 7 days (production)
- **Point-in-Time Recovery**: Enabled for all environments
- **Transaction Logs**: Retained according to backup retention period

### Manual Snapshots

- **Pre-Deployment Snapshots**: Automated as part of deployment pipeline
- **Major Change Snapshots**: Required before schema changes
- **Snapshot Naming Convention**: `{environment}-{purpose}-{YYYY-MM-DD}`

### Disaster Recovery

- **Recovery Time Objective (RTO)**: 
  - Development: < 2 hours
  - Staging: < 1 hour
  - Production: < 30 minutes
- **Recovery Point Objective (RPO)**: 
  - Development: 24 hours
  - Staging: 6 hours  
  - Production: 1 hour
- **Cross-Region DR**: Optional for production (not enabled by default)

## Performance Monitoring

### CloudWatch Metrics

- **CPU Utilization**: Alert threshold at 80%
- **Memory Utilization**: Alert threshold at 80%
- **Disk Queue Depth**: Alert threshold at 10
- **Free Storage Space**: Alert threshold at 10% of allocated storage
- **Database Connections**: Alert at 80% of max_connections
- **Replica Lag**: Alert threshold at 5 minutes (when replicas configured)

### Performance Insights

- **Enabled For**: Staging and production environments
- **Retention Period**: 7 days (default), 2 years (production)
- **Top SQL Queries**: Tracked and analyzed for optimization
- **Wait Events**: Monitored for bottleneck identification

### Enhanced Monitoring

- **Enabled For**: All environments
- **Granularity**: 60 seconds
- **Metrics Collected**: OS-level metrics (CPU, memory, file system, disk I/O)

## Database Schema Management

### Schema Migration Strategy

- **Migration Framework**: Node.js migration framework (configured in application)
- **Migration Table**: `schema_migrations` tracks applied migrations
- **Migration Scripts**: Stored in `backend/database/migrations/`
- **Migration Naming**: `YYYYMMDDHHMMSS-descriptive-name.js`

### Database Tables

The following core tables are implemented in the PostgreSQL database:

1. **users**
   - Primary key: `id` (UUID)
   - Authentication identifiers
   - Profile information
   - Role and permission data

2. **waste_items**
   - Primary key: `id` (UUID)
   - Waste classification data
   - Disposal method information
   - Image references
   - Timestamps and user references

3. **locations**
   - Primary key: `id` (UUID)
   - Geographical coordinates
   - Location type and details
   - Operating hours 
   - Contact information

4. **disposal_records**
   - Primary key: `id` (UUID)
   - References to users, waste_items, and locations
   - Timestamps and quantities
   - Impact metrics

5. **statistics**
   - Primary key: `id` (UUID)
   - Aggregated waste metrics
   - User activity summaries
   - Environmental impact calculations

### Indexing Strategy

- **Primary Keys**: All tables have UUID primary keys
- **Foreign Keys**: Indexed for join performance
- **Composite Indexes**: Applied for common query patterns
- **Partial Indexes**: For selective queries on large tables

## Maintenance Procedures

### Routine Maintenance

- **Vacuum**: Automated (autovacuum enabled)
- **Analyze**: Automated (autovacuum enabled)
- **Parameter Group Updates**: Managed through Terraform

### Patching Strategy

- **Minor Version Updates**: Auto-applied during maintenance window
- **Major Version Updates**: Planned and executed manually
- **Maintenance Window**: Sundays 06:00-08:00 UTC (configurable)

### Monitoring and Alerting

- **CloudWatch Alarms**: Set up for all critical metrics
- **SNS Notifications**: Sent to operations team
- **Log Insights**: Configured for error detection

## Connection Details

### Connection String Format

```
postgresql://${username}:${password}@${endpoint}:${port}/${database}
```

### Environment Variables

The following environment variables are provided to the application:

- `RDS_HOSTNAME` - Database hostname
- `RDS_PORT` - Database port (5432)
- `RDS_USERNAME` - Username for database connection
- `RDS_PASSWORD` - Password for database connection
- `RDS_DB_NAME` - Database name

### Secrets Management

- Database credentials are stored in AWS Secrets Manager
- Applications retrieve credentials at runtime
- Rotation policy: 90 days (production)

## Terraform Implementation

The PostgreSQL RDS instance is deployed using the Terraform RDS module in the `terraform/modules/rds/` directory. Key configuration files include:

- `main.tf` - Primary RDS resource definitions
- `variables.tf` - Input variables for customization
- `outputs.tf` - Output values for reference

## Application Integration

### Connection Pooling

- **Pool Size**: Minimum 5, Maximum 25 (configurable)
- **Idle Timeout**: 10 seconds
- **Connection Lifetime**: 30 minutes

### Error Handling

- **Connection Failures**: Retry with exponential backoff
- **Deadlocks**: Automatic transaction retry (application level)
- **Read Timeout**: 5 seconds
- **Write Timeout**: 10 seconds

## Conclusion

This RDS PostgreSQL implementation provides a secure, scalable, and maintainable relational database for the UW Help App. The multi-environment approach allows for appropriate resource allocation based on requirements, while ensuring consistent configuration across all environments.

---

## Appendix A: SQL Scripts

### Useful Monitoring Queries

**Find long-running queries:**
```sql
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE pg_stat_activity.state = 'active' AND now() - pg_stat_activity.query_start > interval '5 minutes'
ORDER BY duration DESC;
```

**Table size information:**
```sql
SELECT table_name, pg_size_pretty(pg_total_relation_size(quote_ident(table_name))) AS total_size
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY pg_total_relation_size(quote_ident(table_name)) DESC;
```

**Index usage statistics:**
```sql
SELECT s.relname AS table_name, i.indexrelname AS index_name,
       pg_size_pretty(pg_relation_size(i.indexrelid)) AS index_size,
       idx_scan AS index_scans
FROM pg_stat_user_indexes ui
JOIN pg_index i ON ui.indexrelid = i.indexrelid
JOIN pg_stat_all_tables s ON s.relid = i.indrelid
ORDER BY pg_relation_size(i.indexrelid) DESC;
```

## Appendix B: Common Database Management Commands

### Database Export (from local machine)

```bash
pg_dump -h $RDS_HOSTNAME -U $RDS_USERNAME -d $RDS_DB_NAME -F c -f backup.dump
```

### Database Import (from local machine)

```bash
pg_restore -h $RDS_HOSTNAME -U $RDS_USERNAME -d $RDS_DB_NAME -c backup.dump
```

### Establishing SSL Connection via psql

```bash
psql "postgresql://$RDS_USERNAME:$RDS_PASSWORD@$RDS_HOSTNAME:$RDS_PORT/$RDS_DB_NAME?sslmode=require"
```